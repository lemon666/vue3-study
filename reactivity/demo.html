<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div>hello world</div>
    <script>
      // 需求：
      // 当改变一个数据的时候，自动执行所有依赖这个数据的函数
      //   const data = {
      //     name: "cxr",
      //   };

      //   let myTitle = "";

      //   function update() {
      //     myTitle = data.name + "Title";
      //   }

      //   update();
      //   console.log(myTitle); // cxrTitle
      //   data.name = "abc";
      //   update();
      //   console.log(myTitle); // abcTitle

      // 问题点:
      // 需要收集对当前数据的依赖函数
      //    怎么收集，收集到哪里？
      //    这个依赖函数要怎么获取到呢？
      // 更改数据的时候调用收集好的依赖函数
      //    如何知道数据的更改呢？
      //    如何获取到之前收集好的依赖函数呢？
      const data = {
        name: "cxr",
      };
      const name = "123";
      let myTitle = "";

      function update() {
        myTitle = data.name + "Title";
      }

      // 依赖收集
      const dependCollection = {};
      dependCollection.data = {};
      dependCollection.data.name = [];
      dependCollection.data.name.push(update);
      // -------------------------------------
      // vue2
      // 触发依赖 Object.defineProperty
      // 重新定义属性，监听起来
      function defineReactive(target, key, value) {
        // 深度监听
        observer(value);
        // 核心 API
        Object.defineProperty(target, key, {
          get() {
            return value;
          },
          set(newValue) {
            if (newValue !== value) {
              // 深度监听
              observer(newValue);
              // 设置新值
              // 注意，value 一直在闭包中，此处设置完之后，再 get 时也是会获取最新的值
              value = newValue;

              dependCollection.data.name.forEach((fn) => fn());
            }
          },
        });
      }
      // 监听对象属性
      function observer(target) {
        if (typeof target !== "object" || target === null) {
          // 不是对象或数组
          return target;
        }
        // 重新定义各个属性（for in 也可以遍历数组）
        for (let key in target) {
          defineReactive(target, key, target[key]);
        }
      }
      observer(data);
      data.name = "abv";
      console.log(myTitle);
      // -------------------------------------
      // vue3
      // 触发依赖 Proxy
      //   const handler = {
      //     get: function (obj, prop) {
      //       return Reflect.get(obj, prop);
      //     },
      //     set: function (obj, prop, value) {
      //       const result = Reflect.set(obj, prop, value);
      //       // 触发依赖当前数据的函数
      //       dependCollection.data.name.forEach((fn) => fn());
      //       return result;
      //     },
      //   };

      //   const observed = new Proxy(data, handler);
      //   observed.name = "abv";
      //   console.log(myTitle);
    </script>
  </body>
</html>
